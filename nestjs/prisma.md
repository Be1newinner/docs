To set up **Prisma in NestJS**, the clean and production-ready way (used in FAANG-style backend apps), follow this structured guide.

---

## ✅ Goal

Integrate Prisma ORM into your **NestJS v11+** app with:

* Autogenerated client
* Type-safe DB access
* Modular, injectable `PrismaService`
* Graceful shutdown hooks

---

## 🛠️ Step-by-Step Setup

---

### 1. **Install Prisma and Dependencies**

```bash
npm install prisma --save-dev
npm install @prisma/client
```

---

### 2. **Initialize Prisma**

```bash
npx prisma init
```

This creates:

```
📦 prisma/
 └── schema.prisma
📦 .env (used for DATABASE_URL)
```

---

### 3. **Configure `.env`**

Update your database URL. For PostgreSQL:

```env
DATABASE_URL="postgresql://admin:admin123@localhost:5432/devdb"
```

---

### 4. **Define Your Data Model**

Edit `prisma/schema.prisma`:

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
}
```

---

### 5. **Generate Prisma Client**

```bash
npx prisma generate
```

Also run migrations:

```bash
npx prisma migrate dev --name init
```

---

### 6. **Create `PrismaService`**

#### ➤ `src/prisma/prisma.service.ts`

```ts
import { Injectable, OnModuleInit, INestApplication } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  async onModuleInit() {
    await this.$connect();
  }

  enableShutdownHooks(app: INestApplication): void {
    this.$on('beforeExit', async () => {
      await app.close();
    });
  }
}
```

---

### 7. **Create `PrismaModule`**

#### ➤ `src/prisma/prisma.module.ts`

```ts
import { Global, Module } from '@nestjs/common';
import { PrismaService } from './prisma.service';

@Global()
@Module({
  providers: [PrismaService],
  exports: [PrismaService],
})
export class PrismaModule {}
```

> 🔥 `@Global()` makes PrismaService available app-wide without needing to import the module again.

---

### 8. **Use Prisma in a Service**

#### ➤ `src/users/users.service.ts`

```ts
import { Injectable } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';

@Injectable()
export class UsersService {
  constructor(private prisma: PrismaService) {}

  async findAll() {
    return this.prisma.user.findMany();
  }
}
```

---

### 9. **Use Graceful Shutdown in `main.ts`**

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  const prismaService = app.get(PrismaService);
  prismaService.enableShutdownHooks(app);

  await app.listen(3000);
}
bootstrap();
```

---

### ✅ Summary

Now you have a production-ready Prisma setup:

* Type-safe DB access
* Centralized PrismaService
* Global module for easy injection
* Shutdown handling for Docker/k8s

---

## 🚀 Bonus Tips

* Use `npx prisma studio` for a local DB GUI
* Enable soft deletes via a `deletedAt` field
* Generate types: `npx prisma generate`
* Add validation with `zod` or `class-validator`

---

## ✅ Step-by-Step setup After Cloning nest for prisma to work

### 1. **Start Your Postgres Server**

Make sure your Postgres container or service is running.

Example (Docker):

```bash
docker run -d \
  --name pg-server \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=admin123 \
  -e POSTGRES_DB=devdb \
  -p 5432:5432 \
  postgres:latest
```

---

### 2. **Configure `.env`**

In the cloned project, update your `.env`:

```dotenv
DATABASE_URL="postgresql://admin:admin123@localhost:5432/devdb"
```

✅ Make sure it matches your Postgres credentials.

---

### 3. **Inspect the Prisma Schema**

Check `prisma/schema.prisma` — it should already define the models.

---

### 4. **Run Prisma Migrate**

This will create the DB schema in Postgres:

```bash
npx prisma migrate dev --name init
```

> ⚠️ If you see an error like *“database does not exist”*, ensure Postgres is running and credentials are correct.

---

### 5. **(Optional) Generate Prisma Client**

If it’s not already generated:

```bash
npx prisma generate
```

---

### 6. **(Optional) Open Prisma Studio (GUI)**

```bash
npx prisma studio
```

You can visually inspect your tables and data.

---


## 🔁 If Migrations Are Missing (Edge Case)

If there’s **no `prisma/migrations/` folder**, but there’s a schema, run:

```bash
npx prisma db push
```

This pushes the schema directly to the DB (no migration history, good for dev).

---

## 💡 Pro Tip (FAANG-style)

In production or CI/CD pipelines:

* Use `npx prisma migrate deploy` instead of `migrate dev`.
* Always validate schema changes with `prisma diff`.